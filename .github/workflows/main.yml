name: CI ImplementntacionDummie
on: [push]

jobs: 

  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3.5.3
    
    - name: Setup Java JDK
      uses: actions/setup-java@v3.12.0
      with:
        java-version: '11'
        distribution: 'zulu'

    - name: Build Gradle
      run: |
        chmod +x gradlew
        ./gradlew -q projects  # Listar proyectos Gradle
        ./gradlew clean build bootBuildImage  # Construir y crear imágenes Docker para todos los proyectos desde el proyecto padre

    - name: Analisis SonarCloud
      run: |
        chmod +x gradlew
        ./gradlew sonar -Dsonar.token=${{ secrets.TOKEN_SONARCLOUD }} # Genera el análisis con el token correspondiente

    - name: Docker Login
      uses: docker/login-action@v2.2.0
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Docker Tag y Push
      run: |
        # Se Cambian de nombre de usuario a las imagenes
        docker tag narramadan/spring-multi-module-service-service-a:latest rubejorquera/spring-multi-module-service-service-a:latest
        docker tag narramadan/spring-multi-module-service-service-b:latest rubejorquera/spring-multi-module-service-service-b:latest
        docker tag narramadan/spring-multi-module-service-service-c:latest rubejorquera/spring-multi-module-service-service-c:latest
        # Se suben al repositorio de DockerHub
        docker push rubejorquera/spring-multi-module-service-service-a:latest
        docker push rubejorquera/spring-multi-module-service-service-b:latest
        docker push rubejorquera/spring-multi-module-service-service-c:latest

    - name: Despliegue con Docker Compose
      run: |
        docker-compose up -d
        docker ps
        
    - name: PerfAction for JMeter
      # You may pin to the exact commit or the version.
      # uses: QAInsights/PerfAction@f3959d0a69e7f23949add25d7e34a3ae167d6443
      uses: QAInsights/PerfAction@v3.1
      with:
        # jmeter test plan to execute
        test-plan-path: script.jmx

        
